name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  generate-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.set_output.outputs.release_notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Generate Release Notes with Copilot
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          AI_MODEL: gpt-5-mini
        run: |
          # Get previous tag or root
          PREV_TAG=$(git describe --tags --abbrev=0 --match "v*" HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then RANGE="HEAD"; else RANGE="$PREV_TAG..HEAD"; fi
          
          # Get Git Log for Context
          GIT_LOG=$(git log $RANGE --pretty=format:"%h - %s (%an)")
          
          # Run Copilot
          copilot --model $AI_MODEL -p "
            REPO: ${{ github.repository }}
            VERSION: ${{ github.ref_name }}
            
            CHANGES:
            $GIT_LOG
            
            TASK: Generate meaningful release notes for this version based on the changes above.
            
            GUIDELINES:
            - Start with the title '# Transcriber ${{ github.ref_name }}'
            - Write a brief, engaging summary paragraph explaining what this release achieves.
            - Group changes into '## Key Features' (if there are any) and '## Bug Fixes' (if there are any).
            - Use bullet points.
            - Be concise but descriptive.
            - Ignore trivial commits (docs, chores) unless significant.
            - DO NOT USE EMOJIS anywhere in the output. Use standard Markdown only.
            
            Output ONLY the markdown content using ---review--- marker as start.
          " > temp_review.md

      - name: Extract Markdown Body
        run: |
          if [ -f temp_review.md ]; then
            awk '/---review---/{found=1; next} found' temp_review.md > RELEASE_BODY.md
          fi
          
          # Fallback: Use last commit message if extraction failed or file missing
          if [ ! -s RELEASE_BODY.md ]; then
            git log -1 --pretty=%B > RELEASE_BODY.md
          fi
          
          # Append Footer always
          echo "" >> RELEASE_BODY.md
          echo "## Getting Started" >> RELEASE_BODY.md
          echo "1. Download \`Transcriber.zip\` below." >> RELEASE_BODY.md
          echo "2. Unzip and drag to **Applications**." >> RELEASE_BODY.md
          echo "3. Grant **Accessibility** and **Microphone** permissions on first run." >> RELEASE_BODY.md
      
      - name: Set Output
        id: set_output
        run: |
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat RELEASE_BODY.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build-mac:
    name: Build macOS
    needs: generate-notes
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and Archive
        run: |
          ./build.sh
          
          # Create Zip from build output
          cd build && zip -r ../Transcriber.zip Transcriber.app
          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: Transcriber.zip
          body: ${{ needs.generate-notes.outputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux
    needs: generate-notes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev gir1.2-gtksource-3.0 \
            libpango1.0-dev gir1.2-pango-1.0 libgdk-pixbuf2.0-dev \
            gobject-introspection libgirepository1.0-dev libxml2-dev \
            libpulse-dev xclip xdotool jq wget

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '5.10'

      - name: Build
        run: swift build -c release

      - name: Create AppImage
        run: |
          # Setup AppDir
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications
          
          cp .build/release/transcriber-linux AppDir/usr/bin/transcriber
          
          # Copy resources
          cp Media/AppIcon.png AppDir/transcriber.png
          cp Media/AppIcon.png AppDir/usr/share/icons/hicolor/256x256/apps/transcriber.png
          
          # Create Desktop File
          cat > AppDir/transcriber.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Transcriber
          Exec=transcriber
          Icon=transcriber
          Categories=Utility;
          EOF
          
          cp AppDir/transcriber.desktop AppDir/usr/share/applications/
          
          # Use linuxdeploy
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          
          # Run linuxdeploy
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage

      - name: Rename AppImage
        run: |
          APPIMAGE=$(find . -maxdepth 1 -name '*.AppImage' -type f | head -n 1)
          if [ -z "$APPIMAGE" ]; then
            echo "âŒ Error: No AppImage found"
            exit 1
          fi
          mv "$APPIMAGE" Transcriber-Linux-x86_64.AppImage

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: Transcriber-Linux-x86_64.AppImage
          body: ${{ needs.generate-notes.outputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
