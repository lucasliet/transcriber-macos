name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  generate-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.set_output.outputs.release_notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Generate Release Notes with Copilot
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          AI_MODEL: gpt-5-mini
        run: |
          # Get previous tag or root
          PREV_TAG=$(git describe --tags --abbrev=0 --match "v*" HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then RANGE="HEAD"; else RANGE="$PREV_TAG..HEAD"; fi
          
          # Get Git Log for Context
          GIT_LOG=$(git log $RANGE --pretty=format:"%h - %s (%an)")
          
          # Run Copilot
          copilot --model $AI_MODEL -p "
            REPO: ${{ github.repository }}
            VERSION: ${{ github.ref_name }}
            
            CHANGES:
            $GIT_LOG
            
            TASK: Generate meaningful release notes for this version based on the changes above.
            
            GUIDELINES:
            - Start with the title '# Transcriber ${{ github.ref_name }}'
            - Write a brief, engaging summary paragraph explaining what this release achieves.
            - Group changes into 'Key Features' and 'Bug Fixes'.
            - Use bullet points.
            - Be concise but descriptive.
            - Ignore trivial commits (docs, chores) unless significant.
            - DO NOT USE EMOJIS anywhere in the output. Use standard Markdown only.
            
            Output ONLY the markdown content using ---review--- marker as start.
          " > temp_review.md

      - name: Extract Markdown Body
        run: |
          if [ -f temp_review.md ]; then
            awk '/---review---/{found=1; next} found' temp_review.md > RELEASE_BODY.md
          fi
          
          # Fallback: Use last commit message if extraction failed or file missing
          if [ ! -s RELEASE_BODY.md ]; then
            git log -1 --pretty=%B > RELEASE_BODY.md
          fi
          
          # Append Footer always
          echo "" >> RELEASE_BODY.md
          echo "## Getting Started" >> RELEASE_BODY.md
          echo "1. Download \`Transcriber.zip\` below." >> RELEASE_BODY.md
          echo "2. Unzip and drag to **Applications**." >> RELEASE_BODY.md
          echo "3. Grant **Accessibility** and **Microphone** permissions on first run." >> RELEASE_BODY.md
      
      - name: Set Output
        id: set_output
        run: |
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat RELEASE_BODY.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build-and-release:
    name: Build and Release
    needs: generate-notes
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set App Version
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}
          echo "Setting app version to $VERSION"
          
          # Update Info.plist
          plutil -replace CFBundleShortVersionString -string "$VERSION" Info.plist
          plutil -replace CFBundleVersion -string "$VERSION" Info.plist

      - name: Build App
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Create ZIP
        run: |
          cd build
          ditto -c -k --keepParent Transcriber.app Transcriber.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/Transcriber.zip
          draft: false
          prerelease: false
          body: ${{ needs.generate-notes.outputs.release_notes }}
          generate_release_notes: false
